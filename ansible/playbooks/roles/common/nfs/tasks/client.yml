---
- name: Install NFS package 
  become: yes
  yum: name=nfs-utils state=present

# domain names are very impotant for NFSv4 to work - all clients and server must be in the same base doamin
- block:
    - name: Update /etc/hosts for NFS 
      blockinfile:
        path: /etc/hosts
        block: |
            {{ hostvars[item]['ansible_' + dcos_nic_name].ipv4.address }} {{ hostvars[item].ansible_hostname }}
        marker: "# {mark} ANSIBLE MANAGED BLOCK"
      with_inventory_hostnames: 
        - dcos_slaves:dcos_slaves_public:dcos_bootstrap
    - name: Mapping user names and group IDs to NFSv4 IDs 
      lineinfile: 'dest=/etc/idmapd.conf regexp="^DOMAIN =" line="DOMAIN = {{nfs_base_domain}}" state=present create=yes'        
  when: nfs_version | version_compare('4', operator='eq')
  become: yes


 # check if mouting is successful by showmount -e {{nfs_base_domain}}
- name: Start and Enable rpcbind service 
  become: yes
  systemd: name=rpcbind state=restarted enabled=yes daemon_reload=yes
  changed_when: no


- name: Make sure if NFS mounting point exists
  become: yes
  file: "path={{item.mnt}} state=directory  owner={{ ansible_user_id }} group={{ ansible_user_id }}"
  with_items: "{{nfs_exports}}"
 
   
- name: Mount Shared folder 
  become: yes
  command: "mount -t {{ (nfs_version | version_compare('4', 'eq')) | ternary('nfs4', 'nfs') }} {{nfs_server_fqdn}}:{{item.dir}} {{item.mnt}}"
  with_items: "{{nfs_exports}}"


- name: Make it mounted on system boot 
  become: yes
  lineinfile: 'dest=/etc/fstab regexp="^{{nfs_server_fqdn}}:{{item.dir}}" line="{{nfs_server_fqdn}}:{{item.dir}} {{item.mnt}} nfs defaults 0 0" state=present create=yes'
  with_items: "{{nfs_exports}}"


- name: Remount all 
  become: yes
  command: "mount -a"
