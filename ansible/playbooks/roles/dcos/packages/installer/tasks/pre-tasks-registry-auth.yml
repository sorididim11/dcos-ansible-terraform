---

- name: Check if dcoc/dist dir exists
  file:
    path: "{{ dcos_bootstrap_root_path }}/genconf/serve"
    state: directory


- name: Generate self-signed certificate for registry
  command: >
          openssl req -newkey rsa:4096 -nodes -sha256 
            -subj '/emailAddress=jong-gun.kim@hpe.com/C=KR/ST=Seoul/L=Seoul/O=Global Security/OU=IT Deparment/CN={{service.name}}.marathon.l4lb.thisdcos.directory'
            -keyout {{service.auth.name}}.key  -x509 -days 365 -out {{service.auth.name}}.pem
  args:
    chdir: "{{ dcos_bootstrap_root_path }}/genconf/serve"


- name: Generate auth config file 
  template:
    src: "{{item.src}}"
    dest: "{{item.dest}}"
  with_items:
    - { src: auth_config.yml.j2, dest: "{{ dcos_bootstrap_root_path }}/genconf/serve/auth_config.yml" }
    - { src: registry-auth-config.json.j2, dest: "{{ dcos_bootstrap_root_path }}/packages/{{service.auth.name}}-config.json" }


- name: Install Auth server 
  command: "dcos marathon app add {{ dcos_bootstrap_root_path }}/packages/{{service.auth.name}}-config.json"


- name: Generate docker conf file, daemon.json for docker cli node 
  become: yes
  template: src=daemon.json.j2 dest=/etc/docker/daemon.json   


- name: Restart docker 
  become: yes
  systemd: name=docker state=restarted
  changed_when: False


- name: Generate/Distribute self-signed certificate 
  block:
    - name: Generate self-signed certificate for registry
      command: >
          openssl req -newkey rsa:4096 -nodes -sha256 
            -subj '/emailAddress=jong-gun.kim@hpe.com/C=KR/ST=Seoul/L=Seoul/O=Global Security/OU=IT Deparment/CN={{service.name}}.marathon.l4lb.thisdcos.directory'
            -keyout {{service.name}}.key  -x509 -days 365 -out {{service.name}}.crt
      args:
        chdir: "{{ dcos_bootstrap_root_path }}/genconf/serve"

    - name: Run web container to distribute keys
      become: yes
      docker_container: 
        name: boot-nginx
        image: nginx
        state: started
        ports: "{{dcos_bootstrap_port}}:80"
        volumes: "{{ dcos_bootstrap_root_path }}/genconf/serve:/usr/share/nginx/html:ro"
      changed_when: False

    - name: Insert crts, key to docker cert directory and restart docker engine in each agent
      become: yes
      shell: |
          mkdir -p /etc/docker/certs.d/{{service.name}}.marathon.l4lb.thisdcos.directory:{{service.options.internal_port}} 
          curl -o /etc/docker/certs.d/{{service.name}}.marathon.l4lb.thisdcos.directory:{{service.options.internal_port}}/ca.crt http://{{groups['dcos_cli'][0]}}:{{dcos_bootstrap_port}}/{{service.name}}.crt 
          systemctl restart docker.service
      delegate_to: "{{item}}"
      with_items: "{{ groups['dcos_nodes'] }}"
  when: service.options.is_secure_registry == True


